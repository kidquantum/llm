<!DOCTYPE html>
<html lang="en">
    <head>
        <title>docBERT</title>
    </head>
    <body>
        <h1>docBERT</h1>

        <form action="" id="question_form">
            <label for="question">Question:</label>
            <input type="text" id="question" name="question">
            <label for="dataset_name">Dataset:</label>
            <input type="text" id="dataset_name" name="dataset_name" placeholder="(optional)">
            <label for="top_k">Top K:</label>
            <input type="number" id="top_k" name="top_k" value="3">
            <br><br>
            <input type="submit" id="submit_button" value="Submit">
        </form>
        <h2>History:</h2>
        <table id="answers">
            <tr>
                <th>Question</th>
                <th>Answer</th>
                <th>Source</th>
                <th>Score</th>
            </tr>
        </table>
    </body>
    <script>
        const questionForm = document.getElementById("question_form");
        const questionInput = document.getElementById("question");
        const submitButton = document.getElementById("submit_button");
        const answersTable = document.getElementById("answers");

        function addrow(question, answer="...", source="", score="", idx = 1) {
            const row = answersTable.insertRow(idx);
            const questionCell = row.insertCell(0);
            const answerCell = row.insertCell(1);
            const sourceCell = row.insertCell(2);
            const scoreCell = row.insertCell(3);
            questionCell.innerText = question
            answerCell.innerText = answer
            sourceCell.innerText = source
            scoreCell.innerText = score
            return row
        }

        function updaterow(row, answer, source, score) {
            row.childNodes[1].innerText = answer
            row.childNodes[2].innerText = source
            row.childNodes[3].innerText = score
        }

        if (questionForm) {
            questionForm.addEventListener("submit", async function(e) {
                e.preventDefault();
                submitButton.disabled = true;

                const data = {};
                for (const pair of new FormData(questionForm)) {
                    data[pair[0]] = pair[1];
                }
                questionInput.value = "";

                row = addrow(data["question"])

                const response = await fetch("/api/question", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify(data)
                });
                if (response.ok) {
                    const content = await response.json();
                    for (let i=0; i < content["answers"].length; i++) {
                        answer = content["answers"][i]
                        if (i == 0) {
                            updaterow(row, answer["text"], answer["source"], answer["score"])
                        } else {
                            addrow("-", answer["text"], answer["source"], answer["score"], i + 1)
                        }
                    }
                } else {
                    updaterow(row, "ERROR", "", "")
                }
                submitButton.disabled = false;
            })
        }
    </script>
    <style>
        table {
            min-width: 200px;
        }

        table, th, td {
            border: 1px solid black;
            border-collapse: collapse;
        }

        th, td {
            padding: 0 1em 0 1em;
        }
    </style>
</html>
